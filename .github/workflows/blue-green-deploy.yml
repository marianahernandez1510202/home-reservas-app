name: Blue-Green Deployment Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (blue/green)'
        required: true
        default: 'blue'
        type: choice
        options:
          - blue
          - green
      version:
        description: 'Version to deploy (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      auto_switch:
        description: 'Auto switch traffic after successful deployment'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  VERSION: ${{ github.event.inputs.version || github.sha }}

jobs:
  # ==========================================
  # JOB 1: BUILD AND TEST
  # ==========================================
  build-and-test:
    name: Build and Test Application
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version output
        id: set-version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install backend dependencies
        working-directory: ./server
        run: npm ci

      - name: Run backend tests
        working-directory: ./server
        run: npm test || echo "No tests found, continuing..."

      - name: Install frontend dependencies
        working-directory: ./client
        run: npm ci

      - name: Build frontend
        working-directory: ./client
        run: npm run build

      - name: Run frontend tests
        working-directory: ./client
        run: npm test -- --passWithNoTests || echo "No tests found, continuing..."

  # ==========================================
  # JOB 2: BUILD DOCKER IMAGES
  # ==========================================
  build-images:
    name: Build Docker Images
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/home-backend
          tags: |
            type=raw,value=${{ needs.build-and-test.outputs.version }}
            type=raw,value=latest

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/home-frontend
          tags: |
            type=raw,value=${{ needs.build-and-test.outputs.version }}
            type=raw,value=latest

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # JOB 3: DEPLOY TO ENVIRONMENT
  # ==========================================
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'blue' }}
    needs: [build-and-test, build-images]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://${{ secrets.VPS_HOST }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to VPS
        run: |
          scp -r nginx scripts docker-compose-blue-green.yml .env.production \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/blue-green-app/

      - name: Deploy to target environment
        run: |
          TARGET_ENV="${{ github.event.inputs.environment || 'blue' }}"
          VERSION="${{ needs.build-and-test.outputs.version }}"

          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            cd ~/blue-green-app

            # Export variables
            export VERSION=$VERSION
            export GITHUB_REPOSITORY=${{ github.repository }}

            # Load environment variables
            if [ -f .env.production ]; then
              source .env.production
            fi

            # Make scripts executable
            chmod +x scripts/*.sh

            # Run deployment script
            bash scripts/deploy-$TARGET_ENV.sh $VERSION
          ENDSSH

      - name: Verify deployment
        run: |
          TARGET_ENV="${{ github.event.inputs.environment || 'blue' }}"

          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            cd ~/blue-green-app

            # Run health check
            bash scripts/health-check.sh app-$TARGET_ENV 5000
          ENDSSH

  # ==========================================
  # JOB 4: SWITCH TRAFFIC (Optional)
  # ==========================================
  switch-traffic:
    name: Switch Traffic to New Environment
    needs: deploy
    runs-on: ubuntu-latest
    if: github.event.inputs.auto_switch == 'true'
    environment:
      name: production
      url: http://${{ secrets.VPS_HOST }}

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Switch traffic to new environment
        run: |
          TARGET_ENV="${{ github.event.inputs.environment || 'blue' }}"

          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            cd ~/blue-green-app

            # Switch traffic
            bash scripts/switch.sh $TARGET_ENV
          ENDSSH

      - name: Verify switch
        run: |
          echo "Traffic switched successfully!"
          echo "Application is now running on: ${{ github.event.inputs.environment || 'blue' }}"

  # ==========================================
  # JOB 5: POST-DEPLOYMENT NOTIFICATIONS
  # ==========================================
  notify:
    name: Send Deployment Notification
    needs: [deploy, switch-traffic]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'blue' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify the deployment on the target environment" >> $GITHUB_STEP_SUMMARY
          echo "2. Run manual tests if needed" >> $GITHUB_STEP_SUMMARY
          echo "3. Switch traffic using: \`bash scripts/switch.sh ${{ github.event.inputs.environment || 'blue' }}\`" >> $GITHUB_STEP_SUMMARY
